{% extends "base.html" %}

{% block content %}
    <div class="container mt-4">
        <h2>MBOT_APRILTAG_ARRAY</h2>
        <div id="detection-status" class="alert" role="alert">
            Checking for tags...
        </div>
        <table class="table table-striped">
            <thead>
                <tr>
                    <th scope="col">tag_id</th>
                    <th scope="col">pose_xyz</th>
                    <th scope="col">angles_rpy</th>
                </tr>
            </thead>
            <tbody id="apriltag_data_body">
                <!-- Data will be populated by JavaScript -->
            </tbody>
        </table>
    </div>
    <script>
        async function fetchApriltagData() {
            try {
                const response = await fetch('/apriltag_data');
                if (!response.ok) {
                    throw new Error('Network response was not ok ' + response.statusText);
                }
                const data = await response.json();
                const statusElement = document.getElementById('detection-status');
                const tbody = document.getElementById('apriltag_data_body');
                tbody.innerHTML = ''; // Clear existing data

                // Update the status element based on the response
                if (data.array_size === 0) {
                    statusElement.textContent = "No detection!";
                    statusElement.className = "alert alert-warning";
                } else {
                    statusElement.textContent = "Tag detected!";
                    statusElement.className = "alert alert-success";

                    // Populate the table with detection data
                    if (data.detections) {
                        data.detections.forEach(detection => {
                            const row = document.createElement('tr');
                            const pose = detection.pose || ['N/A', 'N/A', 'N/A'];
                            const angles_rpy = detection.angles_rpy || ['N/A', 'N/A', 'N/A'];
                            const [x, y, z] = pose.map(value => value.toFixed(2));
                            const [roll, pitch, yaw] = angles_rpy.map(value => value.toFixed(2));

                            row.innerHTML = `
                                <td>${detection.tag_id}</td>
                                <td>(${x}, ${y}, ${z})</td>
                                <td>(${roll}, ${pitch}, ${yaw})</td>
                            `;
                            tbody.appendChild(row);
                        });
                    }
                }
            } catch (error) {
                console.error('Fetch error:', error);
                const statusElement = document.getElementById('detection-status');
                statusElement.textContent = 'Error fetching data';
                statusElement.className = "alert alert-danger";
            }
        }

        // Fetch status every 1 second
        setInterval(fetchApriltagData, 1000); 

        // Fetch status on page load
        window.onload = fetchApriltagData; 
    </script>
{% endblock %}
